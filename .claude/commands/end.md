---
name: end
description: End work session with complete cleanup and documentation
---

When the user types /end, perform these actions:

**FIRST: Invoke Repository Hygiene Skill** (MANDATORY)
- Use Skill tool to invoke: `repository-hygiene`
- This ensures proper cleanup practices are followed
- WAIT for skill to load before proceeding

1. **Session Timestamp**:
   - Say "üèÅ Ending development session at [timestamp]..."
   - Note session duration if /start was used

2. **Run Smart Cleanup**:
   - Execute `.claude/cleanup.sh` if it exists
   - Clean project-specific artifacts based on detected type:
     - Node: node_modules/.cache, .next, dist
     - Python: __pycache__, .pytest_cache, *.pyc
     - Rust: target/debug, target/release
     - Go: go build cache
   - Remove OS artifacts (.DS_Store, Thumbs.db, *~)
   - Report what was cleaned

3. **Repository Hygiene Audit**:
   ```
   =================== Repository Hygiene Check ===================
   ```
   - Check for debug statements:
     - JavaScript/TypeScript: console.log, console.debug, debugger
     - Python: print() statements, breakpoint()
     - Go: fmt.Println in non-main files
   - Scan for potential secrets:
     - Patterns: api_key, password, token, secret, private_key
     - AWS/GCP/Azure credentials
   - Verify .env files are gitignored
   - Find TODOs without issue numbers
   - Check for uncommitted changes
   - Report all findings in a structured format

4. **Memory Management with Rotation**:
   - Check `.claude/memory.md` size
   - If > 2000 lines:
     - Archive to `.claude/memory_archive_[date].md`
     - Keep last 500 lines in active memory
   - Add session summary with:
     ```
     ## Session: [date and time]
     **Duration**: [if available]
     **Branch**: [current git branch]

     ### Work Completed:
     - [bullet points]

     ### Key Decisions:
     - [if any]

     ### Blockers/Issues:
     - [if any]

     ### Next Steps:
     - [priorities for next session]
     ```

5. **Create Session Log**:
   - Save to `.claude/logs/sessions/[timestamp].md`
   - Include full hygiene report, git status, work summary

6. **Update Core Documentation** (if docs exist):
   - Update `docs/PROJECT.md` status section
   - Clear `docs/CURRENT_SESSION.md`
   - Update progress in `docs/ROADMAP.md` if applicable

7. **Move Files and Commit USS Changes**:

   **Step 7a: Check for misplaced files using Glob (works without bash)**
   - Use Glob tool to find: `session-*` in root
   - Use Glob tool to find: `test-*` in root
   - If files found, note them for moving

   **Step 7b: Move files to proper locations**
   - Try to move session-* scripts to scripts/:
     ```bash
     for file in session-*; do
       [ -f "$file" ] && git mv "$file" scripts/ 2>/dev/null || echo "‚ö†Ô∏è Failed to move $file"
     done
     ```

   - Try to move test-* scripts to scripts/tests/:
     ```bash
     mkdir -p scripts/tests 2>/dev/null
     for file in test-*; do
       [ -f "$file" ] && git mv "$file" scripts/tests/ 2>/dev/null || echo "‚ö†Ô∏è Failed to move $file"
     done
     ```

   **Step 7c: Commit USS changes**
   - Try to commit USS changes:
     ```bash
     git add .claude/ docs/CURRENT_SESSION.md docs/PROJECT.md scripts/ 2>/dev/null
     git commit -m "chore: End session - USS cleanup and documentation

- Updated session memory and documentation
- Repository hygiene maintenance
- Moved utility/session scripts to proper locations

ü§ñ Generated by USS /end command"
     ```

   **Step 7d: Handle failures gracefully**
   - If bash commands succeed:
     - Report: "‚úÖ USS changes committed"

   - If bash commands fail (Bash tool unavailable):
     - Report: "‚ö†Ô∏è Bash tool unavailable - manual cleanup required"
     - Use Glob to check if files still in root
     - Provide exact manual commands:
       ```
       MANUAL CLEANUP NEEDED:

       # Move misplaced files
       git mv session-* scripts/
       git mv test-* scripts/tests/

       # Commit USS changes
       git add .claude/ docs/ scripts/
       git commit -m "chore: End session - USS cleanup"
       ```
     - DO NOT report "Session ended successfully"
     - DO NOT report "USS changes committed" when they weren't

   **Step 7e: Report remaining changes**
   - If other uncommitted changes exist (user's work):
     - List them clearly
     - Say: "Note: [count] files remain uncommitted (may be from previous sessions)"

8. **Git Status Summary**:
   ```
   =================== Git Status ===================
   Branch: [branch name]
   USS Changes: [‚úÖ Committed | ‚ö†Ô∏è Manual cleanup required]
   Your Changes: [count] files uncommitted
   Uncommitted files: [list main files]

   [If bash failed: show "Files in root: session-start, session-end, ..." if any remain]
   ```

9. **Final Session Report**:
   ```
   =================== Session Summary ===================
   Duration: [time]
   Files Modified: [count]
   Lines Added/Removed: +[added] -[removed]

   Hygiene Score: [‚úÖ Clean | ‚ö†Ô∏è Warnings | ‚ùå Critical]
   - Debug statements: [count or ‚úì]
   - Potential secrets: [count or ‚úì]
   - TODOs without issues: [count or ‚úì]

   Token Usage: [estimate] / 200k
   Memory Size: [lines] lines

   Next Priorities:
   1. [from memory/notes]
   2. [from memory/notes]
   ```

10. **Cleanup Complete**:

   **If all operations succeeded:**
   - Report: "‚úÖ Session ended successfully! USS changes committed."
   - If non-USS files uncommitted: "Note: [count] files remain uncommitted (may be from previous sessions). Run `git status` to review."
   - If repository fully clean: "Repository is clean. Ready for next session."
   - Suggest: "Next session: Use /start to begin"

   **If bash tool failed:**
   - Report: "‚ö†Ô∏è Session ended with manual cleanup required"
   - DO NOT say "successfully"
   - List files still in root (from Glob check in step 7a)
   - Remind user of manual commands provided in step 7d
   - Suggest: "Run the manual cleanup commands above, then use /start for next session"

   **Important**: Do NOT say "Your work changes remain uncommitted" - that implies work from THIS session is uncommitted. Be accurate about whether changes are from this session or pre-existing.

Note: This command consolidates ALL cleanup functionality into one place. No need for separate bash scripts or multiple cleanup systems.
