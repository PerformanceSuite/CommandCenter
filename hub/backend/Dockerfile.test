# Hub Backend Test Dockerfile
# Includes Docker for Dagger SDK integration tests

FROM python:3.11-slim AS base

WORKDIR /app

# Install system dependencies including Docker CLI
RUN apt-get update && apt-get install -y \
    docker.io \
    ca-certificates \
    curl \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install test dependencies
RUN pip install --no-cache-dir \
    pytest==7.4.3 \
    pytest-asyncio==0.21.1 \
    pytest-cov==4.1.0 \
    pytest-timeout==2.2.0

# Copy application code
COPY . .

# Create test results directory
RUN mkdir -p /app/test-results /app/coverage

# Set Python path
ENV PYTHONPATH=/app

# Default command: run tests with coverage
CMD ["pytest", "-v", \
     "--cov=app", \
     "--cov-report=xml:/app/coverage/coverage.xml", \
     "--cov-report=html:/app/coverage/htmlcov", \
     "--cov-report=term-missing", \
     "--junitxml=/app/test-results/junit.xml"]
